name: Block New Markdown and Shell Files

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-new-files:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      pull-requests: write
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for new .md or .sh files
        id: check
        run: |
          git fetch origin ${{ github.base_ref }}
          BLOCKED=$(git diff --diff-filter=A --name-only origin/${{ github.base_ref }}...HEAD | grep -iE '\.(md|sh)$' || true)

          if [ -n "$BLOCKED" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$BLOCKED" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Post comment and fail
        if: steps.check.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const files = `${{ steps.check.outputs.files }}`;
            const fileList = files.split('\n').filter(f => f.trim()).map(f => `- \`${f}\``).join('\n');

            const body = [
              '## ⛔ PR Blocked: New .md or .sh Files Detected',
              '',
              'This PR adds new Markdown (.md) or Shell (.sh) files, which is not allowed.',
              '',
              '**Blocked files:**',
              fileList,
              '',
              '**Action Required:** Please remove these files.'
            ].join('\n');

            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const botComment = comments.data.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('⛔ PR Blocked')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body
              });
            }

            core.setFailed('New .md or .sh files are not allowed');
