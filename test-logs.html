<!DOCTYPE html>
<html>
<head>
    <title>Log WebSocket Test</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        #status {
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .connected {
            background: #264f27;
            color: #4ec950;
        }
        .disconnected {
            background: #5a1e1e;
            color: #f48771;
        }
        #logs {
            background: #252526;
            padding: 15px;
            border-radius: 4px;
            height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-left: 3px solid;
        }
        .log-debug {
            border-color: #6B7280;
            color: #9CA3AF;
        }
        .log-info {
            border-color: #3B82F6;
            color: #60A5FA;
        }
        .log-warn {
            border-color: #F59E0B;
            color: #FCD34D;
        }
        .log-error {
            border-color: #EF4444;
            color: #F87171;
        }
        button {
            margin: 10px 5px;
            padding: 8px 15px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #005a9e;
        }
    </style>
</head>
<body>
    <h1>Log WebSocket Test</h1>
    <div id="status" class="disconnected">Disconnected</div>
    
    <div>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="testBackendLog()">Test Backend Log</button>
    </div>
    
    <div id="logs"></div>

    <script>
        let ws = null;
        const logsDiv = document.getElementById('logs');
        const statusDiv = document.getElementById('status');

        function updateStatus(connected) {
            if (connected) {
                statusDiv.textContent = 'Connected to Log WebSocket';
                statusDiv.className = 'connected';
            } else {
                statusDiv.textContent = 'Disconnected';
                statusDiv.className = 'disconnected';
            }
        }

        function addLog(entry) {
            const logDiv = document.createElement('div');
            const levelMap = {
                0: 'debug',
                1: 'info',
                2: 'warn',
                3: 'error'
            };
            const level = levelMap[entry.level] || 'info';
            logDiv.className = `log-entry log-${level}`;
            
            const timestamp = new Date(entry.timestamp).toLocaleTimeString();
            const component = entry.component ? `[${entry.component}]` : '';
            
            logDiv.textContent = `[${timestamp}] ${level.toUpperCase()} ${component} ${entry.message}`;
            
            if (entry.metadata) {
                logDiv.textContent += '\n  ' + JSON.stringify(entry.metadata, null, 2);
            }
            
            logsDiv.appendChild(logDiv);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function connect() {
            if (ws) {
                ws.close();
            }

            ws = new WebSocket('ws://localhost:3001/logs');

            ws.onopen = () => {
                console.log('Connected to log WebSocket');
                updateStatus(true);
                addLog({
                    level: 1,
                    timestamp: new Date().toISOString(),
                    message: 'Connected to log stream',
                    component: 'Test'
                });
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received message:', data);
                    
                    if (data.type === 'log-batch' && Array.isArray(data.entries)) {
                        data.entries.forEach(entry => addLog(entry));
                    }
                } catch (err) {
                    console.error('Failed to parse message:', err);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addLog({
                    level: 3,
                    timestamp: new Date().toISOString(),
                    message: 'WebSocket error occurred',
                    component: 'Test'
                });
            };

            ws.onclose = () => {
                console.log('Disconnected from log WebSocket');
                updateStatus(false);
                addLog({
                    level: 2,
                    timestamp: new Date().toISOString(),
                    message: 'Disconnected from log stream',
                    component: 'Test'
                });
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function clearLogs() {
            logsDiv.innerHTML = '';
        }

        function testBackendLog() {
            // Make a request to backend to generate some logs
            fetch('http://localhost:3001/api/neo4j/status')
                .then(res => res.json())
                .then(data => {
                    console.log('Neo4j status:', data);
                    addLog({
                        level: 1,
                        timestamp: new Date().toISOString(),
                        message: `Neo4j status: ${data.connected ? 'Connected' : 'Disconnected'}`,
                        component: 'Test',
                        metadata: data
                    });
                })
                .catch(err => {
                    console.error('Failed to fetch status:', err);
                    addLog({
                        level: 3,
                        timestamp: new Date().toISOString(),
                        message: 'Failed to fetch Neo4j status',
                        component: 'Test',
                        metadata: { error: err.message }
                    });
                });
        }

        // Auto-connect on load
        window.addEventListener('load', () => {
            setTimeout(connect, 500);
        });
    </script>
</body>
</html>