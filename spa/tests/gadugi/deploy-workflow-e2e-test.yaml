# Azure Tenant Grapher - Full Deploy Workflow E2E Test
# Level 3: Complete end-to-end test including scan and deployment (dry run)
# Tests the complete user journey: scan tenant -> generate IaC -> deploy (dry run)

name: "ATG Deploy Workflow - End-to-End with Dry Run"
description: "Verifies complete user workflow from scan through deployment dry run"
version: "1.0.0"

# Test configuration
config:
  timeout: 600000  # 10 minutes for complete workflow
  retries: 1
  parallel: false
  evidence_dir: "./evidence/deploy-workflow"

# Test metadata
metadata:
  tags: ["e2e", "deploy", "critical", "electron", "dry-run"]
  priority: "critical"
  application: "Azure Tenant Grapher"
  author: "ATG Team"

# Prerequisites
prerequisites:
  - "Neo4j database is installed and accessible"
  - "Backend server can start on port 3001"
  - "Azure CLI is installed and configured"
  - "Terraform installed and accessible"
  - "Valid Azure tenant credentials available"
  - "Electron app built and ready to launch"

# Environment variables
environment:
  variables:
    NODE_ENV: "test"
    PORT: "3001"
    TEST_TENANT_ID: "contoso.onmicrosoft.com"
    DRY_RUN: "true"

# Specialized agent configuration
agents:
  - name: "electron-ui"
    type: "electron"
    config:
      executable: "./node_modules/.bin/electron"
      args: ["."]
      wait_for_window: true
      timeout: 30000
      viewport:
        width: 1920
        height: 1080

# Test steps
steps:
  # ============================================
  # Phase 1: Application Launch
  # ============================================

  - name: "Launch Azure Tenant Grapher"
    agent: "electron-ui"
    action: "launch"
    params:
      target: "./node_modules/.bin/electron"
      args: ["."]
      wait_for_window: true
      timeout: 30000
    expect:
      window_visible: true
    description: "Start the Electron application"

  - name: "Wait for app initialization"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "[role='tablist']"
      timeout: 10000
    description: "Wait for main navigation to render"

  - name: "Capture app launched"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "01-app-launched.png"
      full_page: true
    description: "Evidence: Application ready"

  # ============================================
  # Phase 2: Quick Scan Setup
  # ============================================

  - name: "Navigate to Scan tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Scan"
      timeout: 5000
    description: "Click Scan tab"

  - name: "Wait for Scan tab"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "input[aria-label='Tenant ID']"
      timeout: 5000
    description: "Wait for Tenant ID input"

  - name: "Enter Tenant ID"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label='Tenant ID']"
      value: "${TEST_TENANT_ID}"
    description: "Enter test tenant ID"

  - name: "Set resource limit for fast scan"
    agent: "electron-ui"
    action: "checkbox"
    params:
      selector: "input[type='checkbox'][aria-label*='Resource Limit']"
      checked: true
    description: "Enable resource limit"
    continue_on_failure: true

  - name: "Configure small resource limit"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
      value: "10"
    description: "Set limit to 10 resources for quick test"
    continue_on_failure: true

  - name: "Capture scan configured"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "02-scan-configured.png"
      full_page: true
    description: "Evidence: Scan parameters set"

  # ============================================
  # Phase 3: Execute Quick Scan
  # ============================================

  - name: "Check Neo4j status"
    agent: "electron-ui"
    action: "verify_element"
    params:
      text: "Start Neo4j"
      timeout: 3000
    id: "neo4j_check"
    continue_on_failure: true
    description: "Check if Neo4j needs starting"

  - name: "Start Neo4j if needed"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Start Neo4j"
      timeout: 3000
    condition: "neo4j_check.passed"
    continue_on_failure: true
    description: "Start Neo4j database"

  - name: "Wait for Neo4j ready"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: ".MuiAlert-root"
      contains: "connected"
      timeout: 30000
    condition: "neo4j_check.passed"
    continue_on_failure: true
    description: "Wait for Neo4j connection"

  - name: "Click Start Scan"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 5000
    description: "Start the scan"

  - name: "Verify scan started"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "[role='progressbar']"
      timeout: 10000
    description: "Confirm scan progress indicator"
    continue_on_failure: true

  - name: "Capture scan started"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "03-scan-started.png"
      full_page: true
    description: "Evidence: Scan running"

  - name: "Wait for scan completion"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 90000
      reappears: true
    description: "Wait for scan to finish (max 90s)"
    continue_on_failure: true

  - name: "Capture scan completed"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "04-scan-completed.png"
      full_page: true
    description: "Evidence: Scan finished"

  # ============================================
  # Phase 4: Navigate to Deploy Tab
  # ============================================

  - name: "Navigate to Deploy tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Deploy"
      timeout: 5000
    description: "Click Deploy tab in navigation"

  - name: "Wait for Deploy tab to load"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "h6"
      timeout: 10000
    description: "Wait for Deploy tab content"

  - name: "Verify Deploy tab loaded"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "h6"
      contains: "Deploy"
      timeout: 5000
    description: "Confirm Deploy tab active"

  - name: "Capture Deploy tab initial"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "05-deploy-tab-loaded.png"
      full_page: true
    description: "Evidence: Deploy tab ready"

  # ============================================
  # Phase 5: Configure Deployment
  # ============================================

  - name: "Verify deployment options visible"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "input[type='checkbox']"
      timeout: 5000
    description: "Check deployment configuration controls present"

  - name: "Enable Dry Run mode"
    agent: "electron-ui"
    action: "checkbox"
    params:
      selector: "input[type='checkbox'][aria-label*='Dry Run']"
      checked: true
    description: "Enable dry run mode (no actual deployment)"
    continue_on_failure: true

  - name: "Select deployment target"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "input[aria-label*='Subscription']"
      timeout: 5000
    description: "Click subscription selector"
    continue_on_failure: true

  - name: "Enter deployment name"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label*='Deployment Name']"
      value: "gadugi-test-deployment"
    description: "Enter deployment name"
    continue_on_failure: true

  - name: "Select deployment region"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "input[aria-label*='Region']"
      timeout: 3000
    description: "Open region selector"
    continue_on_failure: true

  - name: "Choose East US region"
    agent: "electron-ui"
    action: "click"
    params:
      text: "East US"
      timeout: 3000
    description: "Select East US region"
    continue_on_failure: true

  - name: "Capture deployment configured"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "06-deployment-configured.png"
      full_page: true
    description: "Evidence: Deployment parameters set"

  # ============================================
  # Phase 6: Execute Dry Run Deployment
  # ============================================

  - name: "Find Start Deploy button"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "button"
      text_contains: "Deploy"
      timeout: 5000
    description: "Verify Deploy button present"

  - name: "Click Start Deploy button"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Deploy')"
      timeout: 5000
    description: "Initiate deployment (dry run)"

  - name: "Verify deployment started"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "h6:has-text('Deployment Progress')"
      timeout: 10000
    description: "Confirm deployment dashboard appeared"
    continue_on_failure: true

  - name: "Capture deployment started"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "07-deployment-started.png"
      full_page: true
    description: "Evidence: Deployment initiated"

  # ============================================
  # Phase 7: Monitor Deployment Progress
  # ============================================

  - name: "Verify deployment progress indicator"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "[role='progressbar']"
      timeout: 5000
    description: "Confirm progress bar visible"
    continue_on_failure: true

  - name: "Check deployment log viewer"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "[class*='LogViewer']"
      timeout: 5000
    description: "Verify deployment logs visible"
    continue_on_failure: true

  - name: "Verify Terraform output visible"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiTypography-root"
      contains: "Terraform"
      timeout: 10000
    description: "Check for Terraform execution output"
    continue_on_failure: true

  - name: "Verify dry run indicator"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      contains: "Dry Run"
      timeout: 5000
    description: "Confirm dry run mode active"
    continue_on_failure: true

  - name: "Capture deployment in progress"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "08-deployment-in-progress.png"
      full_page: true
    description: "Evidence: Deployment running"

  - name: "Wait for deployment completion"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "button:has-text('Deploy')"
      timeout: 180000
      reappears: true
    description: "Wait for deployment to finish (max 3 min)"
    continue_on_failure: true

  # ============================================
  # Phase 8: Verify Deployment Results
  # ============================================

  - name: "Check deployment status"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      timeout: 5000
    description: "Look for status alert (success or error)"
    continue_on_failure: true

  - name: "Verify resources summary"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiCard-root"
      timeout: 5000
    description: "Check deployment summary cards"
    continue_on_failure: true

  - name: "Check resources to deploy count"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiTypography-root"
      contains: "Resources"
      timeout: 5000
    description: "Verify resources counter"
    continue_on_failure: true

  - name: "Verify Terraform plan output"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiTypography-root"
      contains: "Plan:"
      timeout: 5000
    description: "Check for Terraform plan summary"
    continue_on_failure: true

  - name: "Capture deployment completed"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "09-deployment-completed.png"
      full_page: true
    description: "Evidence: Deployment finished"

  # ============================================
  # Phase 9: Verify Export Spec (Generated IaC)
  # ============================================

  - name: "Navigate to Export Spec tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Export Spec"
      timeout: 5000
    description: "Click Export Spec to view generated IaC"
    continue_on_failure: true

  - name: "Wait for Export Spec tab"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "h6"
      timeout: 10000
    description: "Wait for Export Spec content"
    continue_on_failure: true

  - name: "Verify Terraform code visible"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "code"
      timeout: 5000
    description: "Check that generated Terraform code is displayed"
    continue_on_failure: true

  - name: "Verify resource blocks present"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiTypography-root"
      contains: "resource"
      timeout: 5000
    description: "Confirm Terraform resource blocks generated"
    continue_on_failure: true

  - name: "Capture generated IaC"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "10-export-spec-iac.png"
      full_page: true
    description: "Evidence: Generated Infrastructure as Code"

  # ============================================
  # Phase 10: Verify Generate IaC Tab
  # ============================================

  - name: "Navigate to Generate IaC tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Generate IaC"
      timeout: 5000
    description: "Click Generate IaC tab"
    continue_on_failure: true

  - name: "Wait for Generate IaC tab"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "h6"
      timeout: 10000
    description: "Wait for Generate IaC content"
    continue_on_failure: true

  - name: "Verify IaC generation options"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "button"
      timeout: 5000
    description: "Check IaC generation controls present"
    continue_on_failure: true

  - name: "Capture Generate IaC tab"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "11-generate-iac-tab.png"
      full_page: true
    description: "Evidence: IaC generation interface"

# Cleanup actions
cleanup:
  - name: "Return to Deploy tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Deploy"
      timeout: 3000
    continue_on_failure: true

  - name: "Final screenshot"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "12-cleanup-final.png"
      full_page: true

  - name: "Close application"
    agent: "electron-ui"
    action: "window_action"
    params:
      action: "close"

# Success criteria
success_criteria:
  - "Application launches successfully"
  - "Scan completes with data in Neo4j"
  - "Deploy tab loads without errors"
  - "Deployment can be configured with dry run"
  - "Deployment initiates and shows progress"
  - "Dry run mode is clearly indicated"
  - "Terraform plan output visible"
  - "Deployment completes successfully (dry run)"
  - "Export Spec shows generated Terraform code"
  - "All evidence screenshots captured"

# Notes
notes: |
  **Complete E2E Test with Deployment Dry Run**

  This test performs the full user journey:
  1. Scan Azure tenant (limited to 10 resources for speed)
  2. Navigate to deployment
  3. Configure deployment with dry run mode
  4. Execute Terraform plan (no actual changes)
  5. Verify generated Infrastructure as Code

  **Prerequisites:**
  1. Build the app: `npm run build`
  2. Neo4j available (auto-starts if needed)
  3. Azure CLI configured: `az login`
  4. Terraform installed: `terraform --version`

  **Running the test:**
  ```bash
  cd /path/to/gadugi-agentic-test
  node dist/cli.js run /path/to/spa/tests/gadugi/deploy-workflow-e2e-test.yaml --verbose
  ```

  **Expected Duration:** 5-10 minutes

  **Evidence Location:** ./evidence/deploy-workflow/

  **Outside-In Testing Approach:**
  - Tests from user perspective (UI interactions)
  - Uses visible text, ARIA labels, semantic selectors
  - No access to internal React components or state
  - Validates observable behaviors only

  **Dry Run Safety:**
  - No actual Azure resources created
  - Terraform plan only (no apply)
  - Safe to run in any environment
