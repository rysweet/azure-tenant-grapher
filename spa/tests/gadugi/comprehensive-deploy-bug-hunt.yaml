# Azure Tenant Grapher - Comprehensive Deploy Bug Hunt Test
# Purpose: Find bugs through complete E2E workflow from scan to deploy (dry run)
# Focus: Edge cases, error handling, race conditions, data validation

name: "ATG Deploy Bug Hunt - Comprehensive E2E"
description: "Stress test the complete workflow to find bugs: scan -> generate IaC -> deploy (dry run)"
version: "1.0.0"

config:
  timeout: 900000  # 15 minutes for thorough testing
  retries: 0  # Don't retry - we want to see failures
  parallel: false
  evidence_dir: "./evidence/bug-hunt"
  strict_mode: true  # Fail on any warning or unexpected behavior

metadata:
  tags: ["bug-hunt", "e2e", "stress-test", "edge-cases"]
  priority: "critical"
  application: "Azure Tenant Grapher"
  test_strategy: "exhaustive"

prerequisites:
  - "Neo4j database installed"
  - "Backend server available"
  - "Azure CLI configured"
  - "Terraform installed"
  - "Electron app built"

environment:
  variables:
    NODE_ENV: "test"
    PORT: "3001"
    TEST_TENANT_ID: "test-tenant-12345.onmicrosoft.com"
    DRY_RUN: "true"
    DEBUG: "true"

agents:
  - name: "electron-ui"
    type: "electron"
    config:
      executable: "./node_modules/.bin/electron"
      args: ["."]
      wait_for_window: true
      timeout: 30000
      viewport:
        width: 1920
        height: 1080
      strict_assertions: true

steps:
  # ============================================
  # BUG HUNT PHASE 1: Application Launch Validation
  # ============================================

  - name: "Launch ATG and verify window properties"
    agent: "electron-ui"
    action: "launch"
    params:
      target: "./node_modules/.bin/electron"
      args: ["."]
      wait_for_window: true
      timeout: 30000
    expect:
      window_visible: true
      window_count: 1
    description: "Verify single window launches correctly"

  - name: "Verify window title is set correctly"
    agent: "electron-ui"
    action: "verify_window"
    params:
      title: "Azure Tenant Grapher"
    description: "BUG CHECK: Window should have correct title"

  - name: "Check for console errors on launch"
    agent: "electron-ui"
    action: "verify_console"
    params:
      no_errors: true
    description: "BUG CHECK: No console errors on startup"
    continue_on_failure: true

  - name: "Wait for navigation tabs to render"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "[role='tablist']"
      timeout: 10000
    description: "Core UI should render within 10 seconds"

  - name: "Capture launch state"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "01-launch-state.png"
      full_page: true

  # ============================================
  # BUG HUNT PHASE 2: Scan Tab Edge Cases
  # ============================================

  - name: "Navigate to Scan tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Scan"
      timeout: 5000

  - name: "Wait for Scan tab to load"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "input[aria-label='Tenant ID']"
      timeout: 5000

  # BUG TEST: Empty tenant ID submission
  - name: "BUG TEST: Try to scan with empty tenant ID"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 3000
    description: "Should prevent scan with empty tenant ID"
    continue_on_failure: true

  - name: "Verify error message for empty tenant"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      contains: "required"
      timeout: 3000
    description: "BUG CHECK: Error message should appear"
    continue_on_failure: true

  # BUG TEST: Invalid tenant ID format
  - name: "BUG TEST: Enter invalid tenant ID"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label='Tenant ID']"
      value: "invalid@@@tenant"
    description: "Test invalid character handling"

  - name: "BUG TEST: Try scan with invalid tenant ID"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 3000
    continue_on_failure: true

  - name: "Verify invalid tenant ID error"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      timeout: 3000
    description: "BUG CHECK: Should show validation error"
    continue_on_failure: true

  - name: "Capture invalid tenant state"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "02-invalid-tenant-test.png"

  # Clear and enter valid tenant ID
  - name: "Clear tenant ID field"
    agent: "electron-ui"
    action: "clear"
    params:
      selector: "input[aria-label='Tenant ID']"

  - name: "Enter valid test tenant ID"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label='Tenant ID']"
      value: "${TEST_TENANT_ID}"

  # BUG TEST: Resource limit edge cases
  - name: "Enable resource limit"
    agent: "electron-ui"
    action: "checkbox"
    params:
      selector: "input[type='checkbox'][aria-label*='Resource Limit']"
      checked: true
    continue_on_failure: true

  # BUG TEST: Zero resource limit
  - name: "BUG TEST: Try zero resource limit"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
      value: "0"
    description: "Should reject zero limit"
    continue_on_failure: true

  # BUG TEST: Negative resource limit
  - name: "BUG TEST: Try negative resource limit"
    agent: "electron-ui"
    action: "clear"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
    continue_on_failure: true

  - name: "Enter negative value"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
      value: "-10"
    description: "Should reject negative limit"
    continue_on_failure: true

  # BUG TEST: Extremely large resource limit
  - name: "BUG TEST: Try extremely large resource limit"
    agent: "electron-ui"
    action: "clear"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
    continue_on_failure: true

  - name: "Enter huge value"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
      value: "999999999"
    description: "Should handle large numbers gracefully"
    continue_on_failure: true

  # Set reasonable limit for test
  - name: "Set valid resource limit"
    agent: "electron-ui"
    action: "clear"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
    continue_on_failure: true

  - name: "Enter valid limit"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
      value: "5"
    continue_on_failure: true

  - name: "Capture scan configuration"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "03-scan-configured.png"

  # ============================================
  # BUG HUNT PHASE 3: Neo4j Connection Edge Cases
  # ============================================

  - name: "Check Neo4j status alert"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      timeout: 5000
    description: "Should show Neo4j status"
    continue_on_failure: true

  - name: "BUG TEST: Check if Start Neo4j button exists"
    agent: "electron-ui"
    action: "verify_element"
    params:
      text: "Start Neo4j"
      timeout: 3000
    id: "neo4j_check"
    continue_on_failure: true

  # BUG TEST: Double-click Start Neo4j (race condition)
  - name: "BUG TEST: Click Start Neo4j if needed"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Start Neo4j"
      timeout: 3000
    condition: "neo4j_check.passed"
    continue_on_failure: true

  - name: "BUG TEST: Immediately click Start Neo4j again (race condition)"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Start Neo4j"
      timeout: 1000
    condition: "neo4j_check.passed"
    description: "Should handle rapid double-click gracefully"
    continue_on_failure: true

  - name: "Wait for Neo4j to start"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: ".MuiAlert-root"
      contains: "connected"
      timeout: 45000
    condition: "neo4j_check.passed"
    description: "Neo4j should start within 45 seconds"
    continue_on_failure: true

  # ============================================
  # BUG HUNT PHASE 4: Scan Execution Edge Cases
  # ============================================

  - name: "Verify Update Database button is enabled"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 5000
    description: "Scan button should be clickable"

  # BUG TEST: Double-click scan button (race condition)
  - name: "BUG TEST: Click Update Database"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 5000

  - name: "BUG TEST: Immediately click Update Database again"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 1000
    description: "Should prevent double-scan"
    continue_on_failure: true

  - name: "Verify scan started (progress indicator)"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "[role='progressbar']"
      timeout: 10000
    description: "Progress bar should appear"
    continue_on_failure: true

  - name: "Capture scan started"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "04-scan-started.png"

  # BUG TEST: Monitor for errors during scan
  - name: "BUG TEST: Check for scan errors in logs"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root[severity='error']"
      should_not_exist: true
      timeout: 5000
    description: "No error alerts during scan"
    continue_on_failure: true

  # Wait for scan completion
  - name: "Wait for scan to complete"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 120000
      reappears: true
    description: "Scan should complete within 2 minutes"
    continue_on_failure: true

  - name: "Capture scan completed"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "05-scan-completed.png"

  # BUG TEST: Verify scan results are displayed
  - name: "BUG TEST: Verify scan statistics visible"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiCard-root"
      timeout: 5000
    description: "Scan results should be shown"
    continue_on_failure: true

  # ============================================
  # BUG HUNT PHASE 5: Deploy Tab Navigation
  # ============================================

  - name: "Navigate to Deploy tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Deploy"
      timeout: 5000

  - name: "Wait for Deploy tab to load"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "h6"
      timeout: 10000

  - name: "Capture Deploy tab initial"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "06-deploy-tab-loaded.png"

  # BUG TEST: Deploy with no configuration
  - name: "BUG TEST: Find Deploy button before configuration"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "button"
      text_contains: "Deploy"
      timeout: 5000
    description: "Deploy button should exist"

  - name: "BUG TEST: Try to deploy without configuration"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Deploy')"
      timeout: 3000
    description: "Should prevent deploy without config"
    continue_on_failure: true

  - name: "BUG TEST: Check for validation error"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      timeout: 3000
    description: "Should show validation message"
    continue_on_failure: true

  # ============================================
  # BUG HUNT PHASE 6: Deploy Configuration Edge Cases
  # ============================================

  # BUG TEST: Toggle dry run multiple times
  - name: "BUG TEST: Toggle Dry Run checkbox multiple times"
    agent: "electron-ui"
    action: "checkbox"
    params:
      selector: "input[type='checkbox'][aria-label*='Dry Run']"
      checked: true
    continue_on_failure: true

  - name: "Toggle off"
    agent: "electron-ui"
    action: "checkbox"
    params:
      selector: "input[type='checkbox'][aria-label*='Dry Run']"
      checked: false
    continue_on_failure: true

  - name: "Toggle on again (final state)"
    agent: "electron-ui"
    action: "checkbox"
    params:
      selector: "input[type='checkbox'][aria-label*='Dry Run']"
      checked: true
    description: "Enable dry run for safe testing"
    continue_on_failure: true

  # BUG TEST: Empty deployment name
  - name: "BUG TEST: Leave deployment name empty"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "input[aria-label*='Deployment Name']"
      timeout: 3000
    continue_on_failure: true

  # BUG TEST: Special characters in deployment name
  - name: "BUG TEST: Enter special characters in deployment name"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label*='Deployment Name']"
      value: "test@#$%deployment"
    description: "Should sanitize or reject special chars"
    continue_on_failure: true

  - name: "Clear and enter valid name"
    agent: "electron-ui"
    action: "clear"
    params:
      selector: "input[aria-label*='Deployment Name']"
    continue_on_failure: true

  - name: "Enter valid deployment name"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label*='Deployment Name']"
      value: "gadugi-bug-hunt-test"
    continue_on_failure: true

  # BUG TEST: Select region
  - name: "Click region selector"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "input[aria-label*='Region']"
      timeout: 3000
    continue_on_failure: true

  - name: "Select East US region"
    agent: "electron-ui"
    action: "click"
    params:
      text: "East US"
      timeout: 3000
    continue_on_failure: true

  - name: "Capture deployment configuration"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "07-deployment-configured.png"

  # ============================================
  # BUG HUNT PHASE 7: Deploy Execution
  # ============================================

  - name: "Click Deploy button"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Deploy')"
      timeout: 5000
    description: "Start deployment"

  # BUG TEST: Verify deployment progress appears
  - name: "BUG TEST: Verify deployment progress dashboard"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "h6:has-text('Deployment Progress')"
      timeout: 10000
    description: "Deployment UI should appear"
    continue_on_failure: true

  - name: "Capture deployment started"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "08-deployment-started.png"

  # BUG TEST: Monitor deployment logs for errors
  - name: "BUG TEST: Verify deployment logs appear"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "[class*='LogViewer']"
      timeout: 10000
    description: "Log viewer should show deployment output"
    continue_on_failure: true

  # BUG TEST: Verify dry run indicator is visible
  - name: "BUG TEST: Verify Dry Run indicator during deployment"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      contains: "Dry Run"
      timeout: 5000
    description: "Should clearly indicate dry run mode"
    continue_on_failure: true

  - name: "Wait for deployment to complete"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "button:has-text('Deploy')"
      timeout: 240000
      reappears: true
    description: "Deployment should complete within 4 minutes"
    continue_on_failure: true

  - name: "Capture deployment completed"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "09-deployment-completed.png"

  # ============================================
  # BUG HUNT PHASE 8: Results Validation
  # ============================================

  # BUG TEST: Verify deployment results
  - name: "BUG TEST: Check deployment status"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiAlert-root"
      timeout: 5000
    description: "Should show deployment status"
    continue_on_failure: true

  - name: "BUG TEST: Verify resources summary exists"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiCard-root"
      timeout: 5000
    description: "Should show deployment summary"
    continue_on_failure: true

  - name: "BUG TEST: Verify Terraform plan output"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiTypography-root"
      contains: "Plan:"
      timeout: 5000
    description: "Should show Terraform plan summary"
    continue_on_failure: true

  # ============================================
  # BUG HUNT PHASE 9: Export Spec Validation
  # ============================================

  - name: "Navigate to Export Spec tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Export Spec"
      timeout: 5000
    continue_on_failure: true

  - name: "Wait for Export Spec content"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "h6"
      timeout: 10000
    continue_on_failure: true

  # BUG TEST: Verify generated code is present
  - name: "BUG TEST: Verify Terraform code generated"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: "code"
      timeout: 5000
    description: "Should show generated Terraform code"
    continue_on_failure: true

  - name: "BUG TEST: Verify resource blocks exist"
    agent: "electron-ui"
    action: "verify_element"
    params:
      selector: ".MuiTypography-root"
      contains: "resource"
      timeout: 5000
    description: "Should have Terraform resource blocks"
    continue_on_failure: true

  - name: "Capture Export Spec state"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "10-export-spec.png"

  # ============================================
  # BUG HUNT PHASE 10: Rapid Tab Switching (Race Conditions)
  # ============================================

  - name: "BUG TEST: Rapid tab switching - Status"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Status"
      timeout: 2000
    description: "Quick switch to Status tab"
    continue_on_failure: true

  - name: "BUG TEST: Rapid tab switching - Scan"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Scan"
      timeout: 1000
    description: "Quick switch to Scan tab"
    continue_on_failure: true

  - name: "BUG TEST: Rapid tab switching - Deploy"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Deploy"
      timeout: 1000
    description: "Quick switch to Deploy tab"
    continue_on_failure: true

  - name: "BUG TEST: Rapid tab switching - Visualize"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Visualize"
      timeout: 1000
    description: "Quick switch to Visualize tab"
    continue_on_failure: true

  - name: "Capture rapid switching state"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "11-rapid-switching-test.png"

  # Return to Deploy for final checks
  - name: "Return to Deploy tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Deploy"
      timeout: 5000

  - name: "Final deployment state screenshot"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "12-final-state.png"

cleanup:
  - name: "Final screenshot before close"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "99-cleanup-final.png"

  - name: "Close application"
    agent: "electron-ui"
    action: "window_action"
    params:
      action: "close"

success_criteria:
  - "Application launches without errors"
  - "Scan tab validates input properly"
  - "Resource limit edge cases handled correctly"
  - "Neo4j connection established successfully"
  - "Scan executes without errors"
  - "Deploy tab loads and accepts configuration"
  - "Dry run mode clearly indicated throughout"
  - "Deployment completes successfully"
  - "Terraform plan output generated"
  - "Export Spec shows generated code"
  - "No race conditions in rapid interactions"
  - "All evidence captured"

bugs_to_look_for:
  - "Empty tenant ID not validated"
  - "Invalid tenant ID format accepted"
  - "Zero or negative resource limits allowed"
  - "Extremely large resource limits cause errors"
  - "Double-click on Start Neo4j causes issues"
  - "Double-click on Update Database starts multiple scans"
  - "Deploy without configuration allowed"
  - "Special characters in deployment name not sanitized"
  - "Dry run mode not clearly indicated"
  - "Race conditions in rapid tab switching"
  - "Missing error messages"
  - "Console errors during execution"
  - "Deployment logs not shown"
  - "Terraform output not displayed"
  - "Export Spec empty or malformed"

notes: |
  **Comprehensive Bug Hunt Test**

  This test deliberately probes edge cases and error conditions to find bugs:

  1. **Input Validation**: Empty, invalid, and extreme values
  2. **Race Conditions**: Double-clicks, rapid tab switching
  3. **Error Handling**: Missing config, invalid formats
  4. **State Management**: Tab switching while operations running
  5. **UI Feedback**: Error messages, progress indicators
  6. **Data Integrity**: Generated code validity

  **Running the test:**
  ```bash
  cd /path/to/gadugi-agentic-test
  ELECTRON_APP_PATH=/home/sumallepally/ATG_WSL/spa \
  TEST_TENANT_ID="test-tenant-12345.onmicrosoft.com" \
  DRY_RUN="true" \
  DEBUG="true" \
  node dist/cli.js run --verbose --timeout 900000 \
    /path/to/comprehensive-deploy-bug-hunt.yaml
  ```

  **Evidence Analysis:**
  Check ./evidence/bug-hunt/ for:
  - Screenshots showing error states
  - Console logs with errors/warnings
  - Timing data for performance issues
  - Execution log with failed assertions

  **Expected Findings:**
  This test uses `continue_on_failure: true` extensively to expose bugs
  without stopping execution. Review the report to see which checks failed.
