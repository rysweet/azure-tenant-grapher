# Azure Tenant Grapher - Edge Case Validation (Slow & Observable)
# Uses ONLY proven gadugi actions, no continue_on_failure, strict assertions

name: "ATG Edge Case Validation - Fail Fast"
description: "Test edge cases with strict validation - fails immediately on first issue"
version: "1.0.0"

config:
  timeout: 300000  # 5 minutes
  retries: 0
  parallel: false
  evidence_dir: "./evidence/edge-cases"

metadata:
  tags: ["edge-cases", "validation", "strict"]
  priority: "high"
  application: "Azure Tenant Grapher"

prerequisites:
  - "Electron app built and ready"

environment:
  variables:
    NODE_ENV: "test"
    TEST_TENANT_ID: "test-tenant-12345.onmicrosoft.com"

agents:
  - name: "electron-ui"
    type: "electron"
    config:
      executable: "./node_modules/.bin/electron"
      args: ["."]
      wait_for_window: true
      timeout: 30000

steps:
  # ==== LAUNCH ====
  - name: "STEP 1: Launch ATG"
    agent: "electron-ui"
    action: "launch"
    params:
      target: "./node_modules/.bin/electron"
      args: ["."]
      wait_for_window: true
      timeout: 30000
    expect:
      window_visible: true
    description: "Launch application - MUST succeed"

  - name: "STEP 2: Wait for UI"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "[role='tablist']"
      timeout: 10000
    description: "Wait for navigation tabs"

  - name: "SCREENSHOT 1: Launched"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-01-launched.png"
      full_page: true

  # ==== NAVIGATE TO SCAN ====
  - name: "STEP 3: Click Scan tab"
    agent: "electron-ui"
    action: "click"
    params:
      text: "Scan"
      timeout: 5000
    description: "Navigate to Scan tab"

  - name: "STEP 4: Wait for Tenant ID input"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: "input[aria-label='Tenant ID']"
      timeout: 5000
    description: "Wait for Scan tab to load"

  - name: "SCREENSHOT 2: Scan tab"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-02-scan-tab.png"
      full_page: true

  # ==== EDGE CASE 1: Empty Tenant ID ====
  - name: "EDGE CASE 1: Click Update Database with EMPTY tenant"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 5000
    description: "STRICT: Attempt scan with no tenant ID"

  - name: "ASSERTION 1: Error alert MUST appear"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: ".MuiAlert-root[severity='error'], .MuiAlert-root"
      timeout: 5000
    description: "WILL FAIL if no validation - error alert required"

  - name: "SCREENSHOT 3: Empty tenant error"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-03-empty-tenant-error.png"
      full_page: true

  # ==== EDGE CASE 2: Invalid Format ====
  - name: "EDGE CASE 2: Enter invalid tenant format"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label='Tenant ID']"
      value: "invalid@@@@format"
    description: "Enter completely invalid tenant ID"

  - name: "SCREENSHOT 4: Invalid tenant entered"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-04-invalid-tenant.png"
      full_page: true

  - name: "EDGE CASE 2: Try to scan"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 5000
    description: "STRICT: Attempt scan with invalid tenant"

  - name: "ASSERTION 2: Validation error MUST appear"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: ".MuiAlert-root"
      timeout: 5000
    description: "WILL FAIL if invalid format accepted"

  - name: "SCREENSHOT 5: Invalid format error"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-05-invalid-format-error.png"
      full_page: true

  # ==== Setup for Resource Limit Tests ====
  - name: "Clear tenant ID"
    agent: "electron-ui"
    action: "clear"
    params:
      selector: "input[aria-label='Tenant ID']"
    description: "Clear invalid tenant"

  - name: "Enter VALID tenant"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[aria-label='Tenant ID']"
      value: "${TEST_TENANT_ID}"
    description: "Set valid tenant for limit tests"

  - name: "Enable resource limit"
    agent: "electron-ui"
    action: "checkbox"
    params:
      selector: "input[type='checkbox'][aria-label*='Resource Limit']"
      checked: true
    description: "Enable resource limit option"

  - name: "SCREENSHOT 6: Valid tenant with limit enabled"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-06-limit-enabled.png"
      full_page: true

  # ==== EDGE CASE 3: Zero Resource Limit ====
  - name: "EDGE CASE 3: Enter zero resource limit"
    agent: "electron-ui"
    action: "type"
    params:
      selector: "input[type='number'][aria-label*='Resource Limit']"
      value: "0"
    description: "Enter zero - should be rejected"

  - name: "SCREENSHOT 7: Zero limit entered"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-07-zero-limit.png"
      full_page: true

  - name: "EDGE CASE 3: Try to scan with zero limit"
    agent: "electron-ui"
    action: "click"
    params:
      selector: "button:has-text('Update Database')"
      timeout: 5000
    description: "STRICT: Should zero be allowed?"

  - name: "Check for error or scan start"
    agent: "electron-ui"
    action: "wait_for_element"
    params:
      selector: ".MuiAlert-root, [role='progressbar']"
      timeout: 5000
    description: "Either error appears OR scan starts - capture which"

  - name: "SCREENSHOT 8: Zero limit result"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "step-08-zero-limit-result.png"
      full_page: true
    description: "Evidence - Did it scan or error?"

cleanup:
  - name: "Final screenshot"
    agent: "electron-ui"
    action: "screenshot"
    params:
      save_as: "final-state.png"
      full_page: true

  - name: "Close app"
    agent: "electron-ui"
    action: "window_action"
    params:
      action: "close"

success_criteria:
  - "Empty tenant ID shows error"
  - "Invalid format shows validation error"
  - "Zero resource limit handled correctly"

expected_bugs:
  - "ASSERTION 1 fails: No error for empty tenant (validation missing)"
  - "ASSERTION 2 fails: Invalid format accepted (validation missing)"
  - "Zero limit allows scan to proceed (should error or default to unlimited)"

notes: |
  **Slow & Observable Edge Case Testing**

  This test uses STRICT assertions that WILL FAIL if edge cases aren't handled.

  Run with:
  ```bash
  cd /home/sumallepally/ATG_WSL/spa/gadugi-comparison/gadugi

  ELECTRON_APP_PATH=/home/sumallepally/ATG_WSL/spa \
  TEST_TENANT_ID="test-tenant-12345.onmicrosoft.com" \
  node dist/cli.js run --verbose \
    -d /home/sumallepally/ATG_WSL/spa/tests/gadugi/ \
    -s "ATG Edge Case Validation - Fail Fast"
  ```

  Expected behavior:
  - Test PASSES: All edge cases handled correctly
  - Test FAILS at ASSERTION 1: Empty tenant validation missing
  - Test FAILS at ASSERTION 2: Invalid format validation missing
  - Screenshot evidence shows exact failure state
